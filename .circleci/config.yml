# .circleci/config.yml

version: 2.1

aliases:
  - &save_cache
    save_cache:
      key: v1-{{ checksum "yarn.lock" }}
      paths:
        - ./node_modules
  - &restore_cache
    restore_cache:
      key: v1-{{ checksum "yarn.lock" }}

install_dependencies_template: &install_dependencies_template
  steps:
    - checkout
    - *restore_cache
    - run: yarn install
    - *save_cache

tests_template: &tests_template
  steps:
    - checkout
    - *restore_cache
    - run: yarn install
    - run: yarn lint
    - run: yarn format:check
    - run: yarn test
    - run: yarn test:cov
    - run: yarn test:e2e
    - *save_cache

jobs:
  install_node_14_dependencies:
    <<: *install_dependencies_template
    docker:
      - image: circleci/node:14

  install_node_16_dependencies:
    <<: *install_dependencies_template
    docker:
      - image: circleci/node:16

  test_node_14:
    <<: *tests_template
    docker:
      - image: circleci/node:14

  test_node_16:
    <<: *tests_template
    docker:
      - image: circleci/node:16

  # docker_push:

  # kubernetes_deploy:

workflows:
  version: 2
  build_and_test:
    jobs:
      - install_node_14_dependencies
      - install_node_16_dependencies
      - test_node_14:
          requires:
            - install_node_14_dependencies
      - test_node_16:
          requires:
            - install_node_16_dependencies
